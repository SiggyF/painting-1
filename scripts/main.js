function loadModel(e,t){for(;layers.length;){var n=layers.pop();console.log("removing",n),e.removeLayer(n)}var i=L.latLng(t.extent.sw[0],t.extent.sw[1]),o=L.latLng(t.extent.ne[0],t.extent.ne[1]),a=L.latLngBounds(i,o);e.fitBounds(a,{animate:!0}),layers.push(L.imageOverlay.canvas(a,{id:"webgl"}).addTo(e)),layers.push(L.imageOverlay.canvas(a,{id:"drawing"}).addTo(e))}function AdvectionFilter(e,t){var n=new PIXI.Matrix;e.renderable=!1,PIXI.AbstractFilter.call(this,["attribute vec2 aVertexPosition;","attribute vec2 aTextureCoord;","attribute vec4 aColor;","uniform mat3 projectionMatrix;","uniform mat3 otherMatrix;","varying vec2 vMapCoord;","varying vec2 vTextureCoord;","varying vec4 vColor;","void main(void)","{","gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);","vTextureCoord = aTextureCoord;","vMapCoord = ( otherMatrix * vec3( aTextureCoord, 1.0)  ).xy;","vColor = vec4(aColor.rgb * aColor.a, aColor.a);","}"].join("\n"),["precision mediump float;","varying vec2 vMapCoord;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform vec2 scale;","uniform bool flipv;","uniform sampler2D uSampler;","uniform sampler2D mapSampler;","void main(void)","{","vec4 map =  texture2D(mapSampler, vMapCoord);","map -= 0.5;","map.xy *= scale;","if (flipv) {","map.y = 1.0 - map.y;","}","/* stop rendering if masked */","gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.x + map.x, vTextureCoord.y + map.y));","if (map.z > 0.0) {","gl_FragColor *= 0.0;","}","}"].join("\n"),{mapSampler:{type:"sampler2D",value:e.texture},otherMatrix:{type:"mat3",value:n.toArray(!0)},scale:{type:"v2",value:{x:1,y:1}},flipv:{type:"bool",value:!1}}),this.maskSprite=e,this.maskMatrix=n;var i=_.get(t,"scale",20);this.scale=new PIXI.Point(i,i);var o=_.get(t,"flipv",!1);this.flipv=o}function loadVideo(e){var t=$("#video-template").html(),n=Handlebars.compile(t),i=n(e);$("#uv-container").html(i)}function addDrawing(e,t){return sketch=Sketch.create({element:e,container:t,autoclear:!1,fullscreen:!1,exists:!0,palette:["black","white"],radius:3,painting:!1,hasDragged:!0,setup:function(){console.log("drawing setup",this)},update:function(){},keydown:function(){},mouseup:function(){this.hasDragged||(console.log("mouseupn dragging",this.dragging),this.painting=!this.painting,this.painting?$("#drawing").addClass("crosshair"):$("#drawing").removeClass("crosshair"))},mousedown:function(){console.log("mousedown dragging",this.dragging),this.hasDragged=!1},mousemove:function(){console.log("mousemove dragging",this.dragging),this.hasDragged=!0},click:function(){console.log("click dragging",this.dragging)},touchmove:function(){if(this.painting)for(var e,t=this.touches.length-1;t>=0;t--)e=this.touches[t],this.lineCap="round",this.lineJoin="round",this.strokeStyle=this.palette[Math.floor(Math.random()*this.palette.length)],this.lineWidth=this.radius,this.beginPath(),this.moveTo(e.ox,e.oy),this.lineTo(e.x,e.y),this.stroke()}})}function startModel(e){console.log("starting model",e)}function updateColors(){var e=[];d3.selectAll("circle.active").each(function(t){var n=d3.rgb(255*t.rgb[0],255*t.rgb[1],255*t.rgb[2]);e.push(n)}),sketch.palette=e}function selectPalette(e){circles.selectAll("circle").remove(),circles.selectAll("circle").data(e).enter().append("circle").attr("cx",function(e){return x(e.x)}).attr("cy",function(e){return y(e.y)}).attr("r",10).style("fill",function(e){return d3.rgb(255*e.rgb[0],255*e.rgb[1],255*e.rgb[2])}).on("click",function(e){console.log("click",e,this),d3.select(this).classed("active",!d3.select(this).classed("active")),updateColors()})}!function(e,t){"object"==typeof exports?module.exports=t(e,e.document):"function"==typeof define&&define.amd?define(function(){return t(e,e.document)}):e.Sketch=t(e,e.document)}(this,function(e,t){"use strict";function n(e){return"[object Array]"==Object.prototype.toString.call(e)}function i(e){return"function"==typeof e}function o(e){return"number"==typeof e}function a(e){return"string"==typeof e}function r(e){return L[e]||String.fromCharCode(e)}function l(e,t,n){for(var i in t)!n&&i in e||(e[i]=t[i]);return e}function s(e,t){return function(){e.apply(t,arguments)}}function c(e){var t={};for(var n in e)t[n]=i(e[n])?s(e[n],e):e[n];return t}function d(e){function t(t){i(t)&&t.apply(e,[].splice.call(arguments,1))}function n(e){for(D=0;D<ee.length;D++)X=ee[D],a(X)?T[(e?"add":"remove")+"EventListener"].call(T,X,E,!1):i(X)?E=X:T=X}function o(){M(_),_=S(o),Y||(t(e.setup),Y=i(e.setup)),q||(t(e.resize),q=i(e.resize)),e.running&&!H&&(e.dt=(O=+new Date)-e.now,e.millis+=e.dt,e.now=O,t(e.update),Z&&(e.retina&&(e.save(),e.scale(J,J)),e.autoclear&&e.clear()),t(e.draw),Z&&e.retina&&e.restore()),H=++H%e.interval}function s(){T=Q?e.style:e.canvas,F=Q?"px":"",W=e.width||e.element.width,G=e.height||e.element.height,e.fullscreen&&(G=e.height=w.innerHeight,W=e.width=w.innerWidth),e.retina&&Z&&J&&(T.style.height=G+"px",T.style.width=W+"px",W*=J,G*=J),T.height!==G&&(T.height=G+F),T.width!==W&&(T.width=W+F),Y&&t(e.resize)}function d(e,t){return $=t.getBoundingClientRect(),e.x=e.pageX-$.left-(w.scrollX||w.pageXOffset),e.y=e.pageY-$.top-(w.scrollY||w.pageYOffset),e.x*=t.width/$.width,e.y*=t.height/$.height,e}function u(t,n){return d(t,e.element),n=n||{},n.ox=n.x||t.x,n.oy=n.y||t.y,n.x=t.x,n.y=t.y,n.dx=n.x-n.ox,n.dy=n.y-n.oy,n}function h(e){if(e.preventDefault(),j=c(e),j.originalEvent=e,j.touches)for(V.length=j.touches.length,D=0;D<j.touches.length;D++)V[D]=u(j.touches[D],V[D]);else V.length=0,V[0]=u(j,K);return l(K,V[0],!0),j}function g(n){for(n=h(n),B=(N=ee.indexOf(R=n.type))-1,e.dragging=/down|start/.test(R)?!0:/up|end/.test(R)?!1:e.dragging;B;)a(ee[B])?t(e[ee[B--]],n):a(ee[N])?t(e[ee[N++]],n):B=0}function m(n){U=n.keyCode,z="keyup"==n.type,te[U]=te[r(U)]=!z,t(e[n.type],n)}function p(n){e.autopause&&("blur"==n.type?C:v)(),t(e[n.type],n)}function v(){e.now=+new Date,e.running=!0}function C(){e.running=!1}function I(){(e.running?C:v)()}function k(){Z&&e.clearRect(0,0,e.width,e.height)}function P(){A=e.element.parentNode,D=b.indexOf(e),A&&A.removeChild(e.element),~D&&b.splice(D,1),n(!1),C()}var _,E,T,A,$,D,F,O,X,j,R,U,z,B,N,W,G,H=0,V=[],q=!1,Y=!1,J=w.devicePixelRatio||1,Q=e.type==y,Z=e.type==f,K={x:0,y:0,ox:0,oy:0,dx:0,dy:0},ee=[e.element,g,"mousedown","touchstart",g,"mousemove","touchmove",g,"mouseup","touchend",g,"click",g,"mouseout",g,"mouseover",x,m,"keydown","keyup",w,p,"focus","blur",s,"resize"],te={};for(U in L)te[L[U]]=!1;return l(e,{touches:V,mouse:K,keys:te,dragging:!1,running:!1,millis:0,now:0/0,dt:0/0,destroy:P,toggle:I,clear:k,start:v,stop:C}),b.push(e),e.autostart&&v(),n(!0),s(),o(),e}for(var u,h,g="E LN10 LN2 LOG2E LOG10E PI SQRT1_2 SQRT2 abs acos asin atan ceil cos exp floor log round sin sqrt tan atan2 pow max min".split(" "),m="__hasSketch",p=Math,f="canvas",v="webgl",y="dom",x=t,w=e,b=[],C={fullscreen:!0,autostart:!0,autoclear:!0,autopause:!0,container:x.body,interval:1,globals:!0,retina:!1,type:f},L={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"},I={CANVAS:f,WEB_GL:v,WEBGL:v,DOM:y,instances:b,install:function(e){if(!e[m]){for(var t=0;t<g.length;t++)e[g[t]]=p[g[t]];l(e,{TWO_PI:2*p.PI,HALF_PI:p.PI/2,QUATER_PI:p.PI/4,random:function(e,t){return n(e)?e[~~(p.random()*e.length)]:(o(t)||(t=e||1,e=0),e+p.random()*(t-e))},lerp:function(e,t,n){return e+n*(t-e)},map:function(e,t,n,i,o){return(e-t)/(n-t)*(o-i)+i}}),e[m]=!0}},create:function(e){return e=l(e||{},C),e.globals&&I.install(self),u=e.element=e.element||x.createElement(e.type===y?"div":"canvas"),h=e.context=e.context||function(){switch(e.type){case f:return u.getContext("2d",e);case v:return u.getContext("webgl",e)||u.getContext("experimental-webgl",e);case y:return u.canvas=u}}(),e.exists||(e.container||x.body).appendChild(u),I.augment(h,e)},augment:function(e,t){return t=l(t||{},C),t.element=e.canvas||e,t.element.className+=" sketch",l(e,t,!0),d(e)}},k=["ms","moz","webkit","o"],P=self,_=0,E="AnimationFrame",T="request"+E,A="cancel"+E,S=P[T],M=P[A],$=0;$<k.length&&!S;$++)S=P[k[$]+"Request"+E],M=P[k[$]+"Cancel"+E];return P[T]=S=S||function(e){var t=+new Date,n=p.max(0,16-(t-_)),i=setTimeout(function(){e(t+n)},n);return _=t+n,i},P[A]=M=M||function(e){clearTimeout(e)},I});var layers=[];L.ImageOverlay.Canvas=L.ImageOverlay.extend({includes:L.Mixin.Events,options:{width:1024,height:1024},initialize:function(e,t){this._bounds=L.latLngBounds(e),L.Util.setOptions(this,t)},_initImage:function(){var e=this._map.latLngToLayerPoint(this._bounds.getNorthWest()),t=this._map.latLngToLayerPoint(this._bounds.getSouthEast()),n=t._subtract(e);this._image=this.canvas=L.DomUtil.create("canvas","leaflet-image-layer"),this.options.id&&(this._image.id=this.options.id),this._image.width=this.options.width||n.x,this._image.height=this.options.width||n.y,this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(this._image,"leaflet-zoom-animated"):L.DomUtil.addClass(this._image,"leaflet-zoom-hide"),this._updateOpacity(),L.Util.extend(this._image,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.Util.bind(this._onImageLoad,this)})},_reset:function(){var e=this._image,t=this._map.latLngToLayerPoint(this._bounds.getNorthWest()),n=this._map.latLngToLayerPoint(this._bounds.getSouthEast()),i=n._subtract(t);e.width=this.options.width||i.x,e.height=this.options.width||i.y,L.DomUtil.setPosition(e,t),e.style.width=i.x+"px",e.style.height=i.y+"px"},_onImageLoad:function(){this.fire("load")}}),L.imageOverlay.canvas=function(e,t){return new L.ImageOverlay.Canvas(e,t)},$(function(){L.mapbox.accessToken="pk.eyJ1Ijoic2lnZ3lmIiwiYSI6Il8xOGdYdlEifQ.3-JZpqwUa3hydjAJFXIlMA";var e=L.mapbox.map("map","siggyf.c74e2e04");L.control.sidebar("sidebar").addTo(e),document.addEventListener("model-selected",function(t){var n=t.detail;console.log("model selected",n),loadModel(e,n);var i=new CustomEvent("model-layers",{detail:n});document.dispatchEvent(i)})}),AdvectionFilter.prototype=Object.create(PIXI.AbstractFilter.prototype),AdvectionFilter.prototype.constructor=AdvectionFilter,AdvectionFilter.prototype.applyFilter=function(e,t,n){var i=e.filterManager;i.calculateMappedMatrix(t.frame,this.maskSprite,this.maskMatrix),this.uniforms.otherMatrix.value=this.maskMatrix.toArray(!0),this.uniforms.scale.value.x=this.scale.x*(1/t.frame.width),this.uniforms.scale.value.y=this.scale.y*(1/t.frame.height),this.uniforms.flipv.value=this.flipv;var o=this.getShader(e);i.applyFilter(o,t,n)},Object.defineProperties(AdvectionFilter.prototype,{map:{get:function(){return this.uniforms.mapSampler.value},set:function(e){this.uniforms.mapSampler.value=e}}});var sketch;$(function(){var e=$("input.slider").slider();e.on("change",function(e){sketch.radius=e.value.newValue}),$("#images a.thumbnail").click(function(e){var t=$(e.currentTarget).find("img").attr("src"),n=new Image;n.onload=function(){sketch.drawImage(n,0,0)},n.src=t,e.preventDefault()}),document.addEventListener("model-layers",function(e){var t=e.detail;console.log("model layers created",t),loadVideo(t),sketch=addDrawing($("#drawing")[0],$("#drawingcontainer")[0]);var n=new CustomEvent("model-loaded",{detail:t});document.dispatchEvent(n)}),fetch("data/colourlovers.json").then(function(e){return e.json()}).then(function(e){var t=$("#colours-template").html(),n=Handlebars.compile(t),i=n({palettes:e});$("#colours").html(i),_.map(e,function(e){$("#palette"+e.id).click(function(){console.log(e.colors,sketch.palette),sketch.palette=_.map(e.colors,function(e){return"#"+e})})})})["catch"](function(e){console.log("parsing failed",e)})}),$(function(){document.addEventListener("model-loaded",function(e){var t=e.detail;console.log("model loaded",t),startModel(t);var n=new CustomEvent("model-started",{detail:t});document.dispatchEvent(n)})}),$(function(){fetch("data/models.json").then(function(e){return e.json()}).then(function(e){var t=$("#model-template").html(),n=Handlebars.compile(t),i=n(e);$("#models").html(i),_.map(e.models,function(e){$("#"+e.id).find("a.load-model").click(function(){console.log(e);var t=new CustomEvent("model-selected",{detail:e});document.dispatchEvent(t)})}),document.dispatchEvent(new CustomEvent("model-selected",{detail:e.models[0]}))})["catch"](function(e){console.log("parsing failed",e)})}),$(function(){"use strict";document.addEventListener("model-started",function(e){function t(){requestAnimationFrame(t),p.scale.y=-1,u.update(),r.render(l),x.render(l,null,!0),$("#cleardrawing").is(":checked")&&d.clearRect(0,0,c.width,c.height),y.texture=x;var e=v;v=x,x=e,x.clear()}var n=e.detail;console.log("model started",n),console.log("looking for webgl context",$("#webgl"));var i=$("#webgl")[0],o=i.width,a=i.height,r=new PIXI.WebGLRenderer(o,a,{view:i,transparent:!0});console.log("created renderer",r);var l=new PIXI.Container,s=new PIXI.Container;l.addChild(s);var c=$("#drawing")[0],d=c.getContext("2d"),u=PIXI.Texture.fromCanvas(c),h=new PIXI.Sprite(u),g=$("#uv")[0];console.log("video",g);var m=PIXI.Texture.fromVideo(g),p=new PIXI.Sprite(m);p.width=o,p.height=a;var f=new AdvectionFilter(p,{scale:n.scale,flipv:n.flipv});l.addChild(p),s.filters=[f],f.scale.x=2,f.scale.y=2;var v=new PIXI.RenderTexture(r,o,a),y=new PIXI.Sprite(v),x=new PIXI.RenderTexture(r,o,a);s.addChild(y),s.addChild(h),t()})});var width=300,height=200,svg=d3.select("#paintings").append("svg"),circles=svg.append("g");svg.attr("width",width).attr("height",height);var x=d3.scale.linear().range([0,width]).domain([-.1,1.1]).nice(),y=d3.scale.linear().range([height,0]).domain([-.1,1.1]).nice();d3.select("#paintingsclear").on("click",function(){d3.selectAll("circle.active").classed("active",!1),updateColors()}),d3.select("#paintingsall").on("click",function(){d3.selectAll("circle").classed("active",!0),updateColors()}),d3.json("data/palettes.json",function(e,t){d3.select("#paintings").append("div").classed("row",!0).selectAll("div").data(t).enter().append("div").classed({"col-xs-3":!0,thumbnail:!0}).append("img").attr("width","60").attr("height","40").attr("src",function(e){return e.url}).on("click",function(e){console.log("click",e,this),selectPalette(e.palette)});var n=t[0].palette;selectPalette(n)}),$(function(){$('input[type="checkbox"]').bootstrapSwitch()});