function loadModel(e,t){"use strict";for(;layers.length;){var n=layers.pop();console.log("removing",n),e.removeLayer(n)}var a=L.latLng(t.extent.sw[0],t.extent.sw[1]),i=L.latLng(t.extent.ne[0],t.extent.ne[1]),o=L.latLngBounds(a,i);e.fitBounds(o,{animate:!0}),layers.push(L.imageOverlay.canvas(o,{id:"webgl"}).addTo(e)),layers.push(L.imageOverlay.canvas(o,{id:"drawing"}).addTo(e))}function lockMap(e){"use strict";e.dragging.disable(),e.touchZoom.disable(),e.doubleClickZoom.disable(),e.scrollWheelZoom.disable(),e.tap&&e.tap.disable(),$("#lockmap").bootstrapSwitch("state",!0,!0),$("#mapban").removeClass("hide")}function unlockMap(e){"use strict";e.dragging.enable(),e.touchZoom.enable(),e.doubleClickZoom.enable(),e.scrollWheelZoom.enable(),e.tap&&e.tap.enable(),$("#lockmap").bootstrapSwitch("state",!1,!0),$("#mapban").addClass("hide")}function AdvectionFilter(e,t){var n=new PIXI.Matrix;e.renderable=!1,PIXI.AbstractFilter.call(this,["attribute vec2 aVertexPosition;","attribute vec2 aTextureCoord;","attribute vec4 aColor;","uniform mat3 projectionMatrix;","uniform mat3 otherMatrix;","varying vec2 vMapCoord;","varying vec2 vTextureCoord;","varying vec4 vColor;","void main(void)","{","gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);","vTextureCoord = aTextureCoord;","vMapCoord = ( otherMatrix * vec3( aTextureCoord, 1.0)  ).xy;","vColor = vec4(aColor.rgb * aColor.a, aColor.a);","}"].join("\n"),fragmentSource,{mapSampler:{type:"sampler2D",value:e.texture},otherMatrix:{type:"mat3",value:n.toArray(!0)},scale:{type:"v2",value:{x:1,y:1}},flipv:{type:"bool",value:!1},upwind:{type:"bool",value:!1}}),this.maskSprite=e,this.maskMatrix=n;var a=_.get(t,"scale",10);this.scale=new PIXI.Point(a,a);var i=_.get(t,"flipv",!1);this.flipv=i;var o=_.get(t,"upwind",!1);this.upwind=o}function loadVideo(e){var t=$("#video-template").html(),n=Handlebars.compile(t),a=n(e);$("#uv-container").html(a)}function loadImage(e){var t=$("#image-template").html(),n=Handlebars.compile(t),a=n(e);$("#uv-container").html(a)}function addDrawing(e,t){return sketch=Sketch.create({element:e,container:t,autoclear:!1,fullscreen:!1,exists:!0,palette:["black","white"],radius:3,painting:!0,hasDragged:!0,setup:function(){console.log("drawing setup",this)},update:function(){},keydown:function(){},mouseup:function(){this.hasDragged||(console.log("mouseupn dragging",this.dragging),this.painting=!this.painting,this.painting?($("#drawing").addClass("crosshair"),$("#drawingban").addClass("hide")):($("#drawing").removeClass("crosshair"),$("#drawingban").removeClass("hide")))},mousedown:function(){console.log("mousedown dragging",this.dragging),this.hasDragged=!1},mousemove:function(){console.log("mousemove dragging",this.dragging),this.hasDragged=!0},click:function(){console.log("click dragging",this.dragging)},touchmove:function(){if(this.painting)for(var e,t=this.touches.length-1;t>=0;t--)e=this.touches[t],this.lineCap="round",this.lineJoin="round",this.strokeStyle=this.palette[Math.floor(Math.random()*this.palette.length)],this.lineWidth=this.radius,this.beginPath(),this.moveTo(e.ox,e.oy),this.lineTo(e.x,e.y),this.stroke()}})}function startModel(e){console.log("starting model",e)}function updateColors(){var e=[];d3.selectAll("circle.active").each(function(t){var n=d3.rgb(255*t.rgb[0],255*t.rgb[1],255*t.rgb[2]);e.push(n)}),sketch.palette=e}function selectPalette(e){circles.selectAll("circle").remove(),circles.selectAll("circle").data(e).enter().append("circle").attr("cx",function(e){return x(e.x)}).attr("cy",function(e){return y(e.y)}).attr("r",10).style("fill",function(e){return d3.rgb(255*e.rgb[0],255*e.rgb[1],255*e.rgb[2])}).on("click",function(e){console.log("click",e,this),d3.select(this).classed("active",!d3.select(this).classed("active")),updateColors()}),circles.selectAll("circle").classed("active",!0),updateColors()}!function(e,t){"object"==typeof exports?module.exports=t(e,e.document):"function"==typeof define&&define.amd?define(function(){return t(e,e.document)}):e.Sketch=t(e,e.document)}(this,function(e,t){"use strict";function n(e){return"[object Array]"==Object.prototype.toString.call(e)}function a(e){return"function"==typeof e}function i(e){return"number"==typeof e}function o(e){return"string"==typeof e}function r(e){return k[e]||String.fromCharCode(e)}function l(e,t,n){for(var a in t)!n&&a in e||(e[a]=t[a]);return e}function s(e,t){return function(){e.apply(t,arguments)}}function c(e){var t={};for(var n in e)a(e[n])?t[n]=s(e[n],e):t[n]=e[n];return t}function d(e){function t(t){a(t)&&t.apply(e,[].splice.call(arguments,1))}function n(e){for(F=0;F<ee.length;F++)U=ee[F],o(U)?T[(e?"add":"remove")+"EventListener"].call(T,U,P,!1):a(U)?P=U:T=U}function i(){A(_),_=S(i),q||(t(e.setup),q=a(e.setup)),V||(t(e.resize),V=a(e.resize)),e.running&&!Z&&(e.dt=(O=+new Date)-e.now,e.millis+=e.dt,e.now=O,t(e.update),Q&&(e.retina&&(e.save(),e.scale(Y,Y)),e.autoclear&&e.clear()),t(e.draw),Q&&e.retina&&e.restore()),Z=++Z%e.interval}function s(){T=J?e.style:e.canvas,D=J?"px":"",B=e.width||e.element.width,H=e.height||e.element.height,e.fullscreen&&(H=e.height=x.innerHeight,B=e.width=x.innerWidth),e.retina&&Q&&Y&&(T.style.height=H+"px",T.style.width=B+"px",B*=Y,H*=Y),T.height!==H&&(T.height=H+D),T.width!==B&&(T.width=B+D),q&&t(e.resize)}function d(e,t){return E=t.getBoundingClientRect(),e.x=e.pageX-E.left-(x.scrollX||x.pageXOffset),e.y=e.pageY-E.top-(x.scrollY||x.pageYOffset),e.x*=t.width/E.width,e.y*=t.height/E.height,e}function u(t,n){return d(t,e.element),n=n||{},n.ox=n.x||t.x,n.oy=n.y||t.y,n.x=t.x,n.y=t.y,n.dx=n.x-n.ox,n.dy=n.y-n.oy,n}function p(e){if(e.preventDefault(),X=c(e),X.originalEvent=e,X.touches)for(G.length=X.touches.length,F=0;F<X.touches.length;F++)G[F]=u(X.touches[F],G[F]);else G.length=0,G[0]=u(X,K);return l(K,G[0],!0),X}function h(n){for(n=p(n),W=(z=ee.indexOf(j=n.type))-1,e.dragging=/down|start/.test(j)?!0:/up|end/.test(j)?!1:e.dragging;W;)o(ee[W])?t(e[ee[W--]],n):o(ee[z])?t(e[ee[z++]],n):W=0}function m(n){N=n.keyCode,R="keyup"==n.type,te[N]=te[r(N)]=!R,t(e[n.type],n)}function g(n){e.autopause&&("blur"==n.type?C:f)(),t(e[n.type],n)}function f(){e.now=+new Date,e.running=!0}function C(){e.running=!1}function L(){(e.running?C:f)()}function I(){Q&&e.clearRect(0,0,e.width,e.height)}function $(){M=e.element.parentNode,F=b.indexOf(e),M&&M.removeChild(e.element),~F&&b.splice(F,1),n(!1),C()}var _,P,T,M,E,F,D,O,U,X,j,N,R,W,z,B,H,Z=0,G=[],V=!1,q=!1,Y=x.devicePixelRatio||1,J=e.type==y,Q=e.type==v,K={x:0,y:0,ox:0,oy:0,dx:0,dy:0},ee=[e.element,h,"mousedown","touchstart",h,"mousemove","touchmove",h,"mouseup","touchend",h,"click",h,"mouseout",h,"mouseover",w,m,"keydown","keyup",x,g,"focus","blur",s,"resize"],te={};for(N in k)te[k[N]]=!1;return l(e,{touches:G,mouse:K,keys:te,dragging:!1,running:!1,millis:0,now:NaN,dt:NaN,destroy:$,toggle:L,clear:I,start:f,stop:C}),b.push(e),e.autostart&&f(),n(!0),s(),i(),e}for(var u,p,h="E LN10 LN2 LOG2E LOG10E PI SQRT1_2 SQRT2 abs acos asin atan ceil cos exp floor log round sin sqrt tan atan2 pow max min".split(" "),m="__hasSketch",g=Math,v="canvas",f="webgl",y="dom",w=t,x=e,b=[],C={fullscreen:!0,autostart:!0,autoclear:!0,autopause:!0,container:w.body,interval:1,globals:!0,retina:!1,type:v},k={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"},L={CANVAS:v,WEB_GL:f,WEBGL:f,DOM:y,instances:b,install:function(e){if(!e[m]){for(var t=0;t<h.length;t++)e[h[t]]=g[h[t]];l(e,{TWO_PI:2*g.PI,HALF_PI:g.PI/2,QUATER_PI:g.PI/4,random:function(e,t){return n(e)?e[~~(g.random()*e.length)]:(i(t)||(t=e||1,e=0),e+g.random()*(t-e))},lerp:function(e,t,n){return e+n*(t-e)},map:function(e,t,n,a,i){return(e-t)/(n-t)*(i-a)+a}}),e[m]=!0}},create:function(e){return e=l(e||{},C),e.globals&&L.install(self),u=e.element=e.element||w.createElement(e.type===y?"div":"canvas"),p=e.context=e.context||function(){switch(e.type){case v:return u.getContext("2d",e);case f:return u.getContext("webgl",e)||u.getContext("experimental-webgl",e);case y:return u.canvas=u}}(),e.exists||(e.container||w.body).appendChild(u),L.augment(p,e)},augment:function(e,t){return t=l(t||{},C),t.element=e.canvas||e,t.element.className+=" sketch",l(e,t,!0),d(e)}},I=["ms","moz","webkit","o"],$=self,_=0,P="AnimationFrame",T="request"+P,M="cancel"+P,S=$[T],A=$[M],E=0;E<I.length&&!S;E++)S=$[I[E]+"Request"+P],A=$[I[E]+"Cancel"+P];return $[T]=S=S||function(e){var t=+new Date,n=g.max(0,16-(t-_)),a=setTimeout(function(){e(t+n)},n);return _=t+n,a},$[M]=A=A||function(e){clearTimeout(e)},L});var layers=[];L.ImageOverlay.Canvas=L.ImageOverlay.extend({includes:L.Mixin.Events,options:{width:1024,height:1024},initialize:function(e,t){"use strict";this._bounds=L.latLngBounds(e),L.Util.setOptions(this,t)},_initImage:function(){"use strict";var e=this._map.latLngToLayerPoint(this._bounds.getNorthWest()),t=this._map.latLngToLayerPoint(this._bounds.getSouthEast()),n=t._subtract(e);this._image=this.canvas=L.DomUtil.create("canvas","leaflet-image-layer"),this.options.id&&(this._image.id=this.options.id),this._image.width=this.options.width||n.x,this._image.height=this.options.width||n.y,this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(this._image,"leaflet-zoom-animated"):L.DomUtil.addClass(this._image,"leaflet-zoom-hide"),this._updateOpacity(),L.Util.extend(this._image,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.Util.bind(this._onImageLoad,this)})},_reset:function(){"use strict";var e=this._image,t=this._map.latLngToLayerPoint(this._bounds.getNorthWest()),n=this._map.latLngToLayerPoint(this._bounds.getSouthEast()),a=n._subtract(t);e.width=this.options.width||a.x,e.height=this.options.width||a.y,L.DomUtil.setPosition(e,t),e.style.width=a.x+"px",e.style.height=a.y+"px"},_onImageLoad:function(){"use strict";this.fire("load")}}),L.imageOverlay.canvas=function(e,t){"use strict";return new L.ImageOverlay.Canvas(e,t)};var ToggleControl=L.Control.extend({options:{position:"topright"},onAdd:function(e){"use strict";var t=L.DomUtil.create("div","my-custom-control leaflet-control leaflet-bar"),n=$('<a id="drawtoggle"></a>');n.append($('<span class="fa-stack"><i class="fa fa-paint-brush fa-stack-1x"></i><i id="drawingban" class="hide fa fa-ban fa-stack-2x"></i></span>')),n.on("click",function(){sketch.painting=!sketch.painting,sketch.painting?($("#drawing").addClass("crosshair"),$("#drawingban").addClass("hide")):($("#drawing").removeClass("crosshair"),$("#drawingban").removeClass("hide"))}),$(t).append(n);var a=$('<a id="maptoggle"></a>');return a.append($('<span class="fa-stack"><i class="fa fa-map-o fa-stack-1x"></i><i id="mapban" class="fa hide fa-ban fa-stack-2x"></i></span>')),a.on("click",function(){$("#mapban").hasClass("hide")?($("#mapban").removeClass("hide"),lockMap(e)):($("#mapban").addClass("hide"),unlockMap(e))}),$(t).append(a),t}});$(function(){"use strict";L.mapbox.accessToken="pk.eyJ1Ijoic2lnZ3lmIiwiYSI6Il8xOGdYdlEifQ.3-JZpqwUa3hydjAJFXIlMA";var e=L.mapbox.map("map","siggyf.c74e2e04");L.control.sidebar("sidebar").addTo(e);var t=new ToggleControl({});t.addTo(e),document.addEventListener("model-selected",function(t){var n=t.detail;console.log("model selected",n),loadModel(e,n);var a=new CustomEvent("model-layers",{detail:n});document.dispatchEvent(a)}),$("#lockmap").is(":checked")?lockMap(e):unlockMap(e),$("#lockmap").on("switchChange.bootstrapSwitch",function(t){console.log(t),$("#lockmap").is(":checked")?lockMap(e):unlockMap(e)})});var fragmentSource=["precision mediump float;","varying vec2 vMapCoord;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform vec2 scale;","uniform bool flipv;","uniform bool upwind;","uniform sampler2D uSampler;","uniform sampler2D mapSampler;","void main(void)","{","vec4 map =  texture2D(mapSampler, vMapCoord);","float extrascale = 1.0;","map -= 0.5;","map.xy *= scale * extrascale;","if (flipv) {","map.y = - map.y;","}","vec2 lookup = vec2(vTextureCoord.x - map.x, vTextureCoord.y - map.y);","if (upwind) {"," vec4 vUpwind = texture2D(mapSampler, vec2(vMapCoord.x - map.x, vMapCoord.y - map.y ));"," vUpwind -= 0.5;"," if (flipv) {","  vUpwind.y = - vUpwind.y;"," }"," vUpwind.xy *= scale *extrascale;"," /* overwrite lookup with upwind */"," lookup = vec2(vTextureCoord.x - 0.5*(map.x + vUpwind.x), vTextureCoord.y - 0.5* (map.y + vUpwind.y));","}","/* stop rendering if masked */","gl_FragColor = texture2D(uSampler, lookup);","if (map.z > 0.0) {","gl_FragColor *= 0.0;","}","}"].join("\n");console.log(fragmentSource),AdvectionFilter.prototype=Object.create(PIXI.AbstractFilter.prototype),AdvectionFilter.prototype.constructor=AdvectionFilter,AdvectionFilter.prototype.applyFilter=function(e,t,n){var a=e.filterManager;a.calculateMappedMatrix(t.frame,this.maskSprite,this.maskMatrix),this.uniforms.otherMatrix.value=this.maskMatrix.toArray(!0),this.uniforms.scale.value.x=this.scale.x*(1/t.frame.width),this.uniforms.scale.value.y=this.scale.y*(1/t.frame.height),this.uniforms.flipv.value=this.flipv,this.uniforms.upwind.value=this.upwind;var i=this.getShader(e);a.applyFilter(i,t,n)},Object.defineProperties(AdvectionFilter.prototype,{map:{get:function(){return this.uniforms.mapSampler.value},set:function(e){this.uniforms.mapSampler.value=e}}});var sketch;$(function(){var e=$("input.slider").slider();e.on("change",function(e){sketch.radius=e.value.newValue}),$("#images a.thumbnail").click(function(e){var t=$(e.currentTarget).find("img").attr("src"),n=new Image;n.onload=function(){sketch.drawImage(n,0,0)},n.src=t,e.preventDefault()}),document.addEventListener("model-layers",function(e){var t=e.detail;console.log("model layers created",t),_.startsWith(_.first(t.uv).type,"image")?loadImage(t):loadVideo(t),sketch=addDrawing($("#drawing")[0],$("#drawingcontainer")[0]);var n=new CustomEvent("model-loaded",{detail:t});document.dispatchEvent(n)}),fetch("data/colourlovers.json").then(function(e){return e.json()}).then(function(e){var t=$("#colours-template").html(),n=Handlebars.compile(t),a=n({palettes:e});$("#colours").html(a),_.map(e,function(e){$("#palette"+e.id).click(function(){console.log(e.colors,sketch.palette),sketch.palette=_.map(e.colors,function(e){return"#"+e})})})})["catch"](function(e){console.log("parsing failed",e)})}),$(function(){document.addEventListener("model-loaded",function(e){var t=e.detail;console.log("model loaded",t),startModel(t);var n=new CustomEvent("model-started",{detail:t});document.dispatchEvent(n)})}),$(function(){fetch("data/models.json").then(function(e){return e.json()}).then(function(e){var t=$("#model-template").html(),n=Handlebars.compile(t),a=n(e);$("#models").html(a),_.map(e.models,function(e){$("#"+e.id).find("a.load-model").click(function(){console.log(e);var t=new CustomEvent("model-selected",{detail:e});document.dispatchEvent(t)})}),document.dispatchEvent(new CustomEvent("model-selected",{detail:e.models[0]}))})["catch"](function(e){console.log("parsing failed",e)})});var displacementFilter;$(function(){"use strict";document.addEventListener("model-started",function(e){function t(){requestAnimationFrame(t),v.scale.y=-1,p.update(),l.render(s),w.render(s,null,!0),$("#cleardrawing").is(":checked")&&u.clearRect(0,0,d.width,d.height),y.texture=w;var e=f;f=w,w=e,w.clear()}function n(){w.clear(),f.clear()}var a=e.detail;console.log("model started",a),console.log("looking for webgl context",$("#webgl"));var i=$("#webgl")[0],o=i.width,r=i.height,l=new PIXI.WebGLRenderer(o,r,{view:i,transparent:!0});console.log("created renderer",l);var s=new PIXI.Container,c=new PIXI.Container;s.addChild(c);var d=$("#drawing")[0],u=d.getContext("2d"),p=PIXI.Texture.fromCanvas(d),h=new PIXI.Sprite(p),m=$("#uv")[0];console.log("video",m);var g=PIXI.Texture.fromVideo(m),v=new PIXI.Sprite(g);v.width=o,v.height=r,displacementFilter=new AdvectionFilter(v,{scale:a.scale,flipv:a.flipv,upwind:!1}),s.addChild(v),c.filters=[displacementFilter],displacementFilter.scale.x=2,displacementFilter.scale.y=2;var f=new PIXI.RenderTexture(l,o,r),y=new PIXI.Sprite(f),w=new PIXI.RenderTexture(l,o,r);c.addChild(y),c.addChild(h),t(),$("#clear3d").click(n)})});var width=300,height=200,svg=d3.select("#paintings").append("svg"),circles=svg.append("g");svg.attr("width",width).attr("height",height);var x=d3.scale.linear().range([0,width]).domain([-.1,1.1]).nice(),y=d3.scale.linear().range([height,0]).domain([-.1,1.1]).nice();d3.select("#paintingsclear").on("click",function(){d3.selectAll("circle.active").classed("active",!1),updateColors()}),d3.select("#paintingsall").on("click",function(){d3.selectAll("circle").classed("active",!0),updateColors()}),d3.json("data/palettes.json",function(e,t){d3.select("#paintings").append("div").classed("row",!0).selectAll("div").data(t).enter().append("div").classed({"col-xs-3":!0,thumbnail:!0}).append("img").attr("width","60").attr("height","40").attr("src",function(e){return e.url}).on("click",function(e){console.log("click",e,this),selectPalette(e.palette)});var n=t[0].palette;selectPalette(n)}),$(function(){$('input[type="checkbox"]').bootstrapSwitch()});