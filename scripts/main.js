function loadModel(e,t){"use strict";for(;layers.length;){var a=layers.pop();console.log("removing",a),e.removeLayer(a)}var n=L.latLng(t.extent.sw[0],t.extent.sw[1]),i=L.latLng(t.extent.ne[0],t.extent.ne[1]),o=L.latLngBounds(n,i);e.fitBounds(o,{animate:!0}),layers.push(L.imageOverlay.canvas(o,{id:"webgl"}).addTo(e)),layers.push(L.imageOverlay.canvas(o,{id:"drawing"}).addTo(e))}function lockMap(e){"use strict";e.dragging.disable(),e.touchZoom.disable(),e.doubleClickZoom.disable(),e.scrollWheelZoom.disable(),e.tap&&e.tap.disable(),$("#lockmap").bootstrapSwitch("state",!0,!0),$("#mapban").removeClass("hide")}function unlockMap(e){"use strict";e.dragging.enable(),e.touchZoom.enable(),e.doubleClickZoom.enable(),e.scrollWheelZoom.enable(),e.tap&&e.tap.enable(),$("#lockmap").bootstrapSwitch("state",!1,!0),$("#mapban").addClass("hide")}function AdvectionFilter(e,t){var a=new PIXI.Matrix;e.renderable=!1,PIXI.AbstractFilter.call(this,["attribute vec2 aVertexPosition;","attribute vec2 aTextureCoord;","attribute vec4 aColor;","uniform mat3 projectionMatrix;","uniform mat3 otherMatrix;","varying vec2 vMapCoord;","varying vec2 vTextureCoord;","varying vec4 vColor;","void main(void)","{","gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);","vTextureCoord = aTextureCoord;","vMapCoord = ( otherMatrix * vec3( aTextureCoord, 1.0)  ).xy;","vColor = vec4(aColor.rgb * aColor.a, aColor.a);","}"].join("\n"),fragmentSource,{mapSampler:{type:"sampler2D",value:e.texture},otherMatrix:{type:"mat3",value:a.toArray(!0)},scale:{type:"v2",value:{x:1,y:1}},flipv:{type:"bool",value:!1},upwind:{type:"bool",value:!1}}),this.maskSprite=e,this.maskMatrix=a;var n=_.get(t,"scale",10);this.scale=new PIXI.Point(n,n);var i=_.get(t,"flipv",!1);this.flipv=i;var o=_.get(t,"upwind",!1);this.upwind=o}function loadVideo(e){var t=$("#video-template").html(),a=Handlebars.compile(t),n=a(e);$("#uv-container").html(n)}function loadImage(e){var t=$("#image-template").html(),a=Handlebars.compile(t),n=a(e);$("#uv-container").html(n)}function addDrawing(e,t){return sketch=Sketch.create({element:e,container:t,autoclear:!1,fullscreen:!1,exists:!0,palette:["black","white"],radius:3,painting:!0,hasDragged:!0,setup:function(){console.log("drawing setup",this)},update:function(){},keydown:function(){},mouseup:function(){this.hasDragged||(console.log("mouseupn dragging",this.dragging),this.painting=!this.painting,this.painting?($("#drawing").addClass("crosshair"),$("#drawingban").addClass("hide")):($("#drawing").removeClass("crosshair"),$("#drawingban").removeClass("hide")))},mousedown:function(){console.log("mousedown dragging",this.dragging),this.hasDragged=!1},mousemove:function(){console.log("mousemove dragging",this.dragging),this.hasDragged=!0},click:function(){console.log("click dragging",this.dragging)},touchmove:function(){if(this.painting)for(var e,t=this.touches.length-1;t>=0;t--)e=this.touches[t],this.lineCap="round",this.lineJoin="round",this.strokeStyle=this.palette[Math.floor(Math.random()*this.palette.length)],this.lineWidth=this.radius,this.beginPath(),this.moveTo(e.ox,e.oy),this.lineTo(e.x,e.y),this.stroke()}})}function startModel(e){console.log("starting model",e)}function particleCulling(e,t,a){"use strict";for(var n=e.length,i=a,o=$("#uvhidden")[0],r=o.width,l=o.height,s=n-1;s>i;s--)_.pullAt(e,s),t.removeChildAt(s);for(var c=0;i-n>c;c++){var d=PIXI.Sprite.fromImage(icon);d.anchor.set(.5),d.alpha=particleAlpha,d.x=Math.random()*r,d.y=Math.random()*l,e.push(d),t.addChild(d)}}function particleTimestep(e,t){"use strict";var a=$("#uv")[0];if(!a.paused&&!a.ended){var n=$("#uvhidden")[0],i=n.getContext("2d"),o=n.width,r=n.height;i.drawImage(a,0,0,o,r);var l=i.getImageData(0,0,o,r);_.each(e,function(a){var n=4*(Math.round(r-a.position.y)*o+Math.round(a.position.x)),i=l.data[n+0]/255-.5,s=l.data[n+1]/255-.5;s*=displacementFilter.uniforms.flipv.value?1:-1;var c=l.data[n+2]/255>.5;c=c||Math.abs(i)+Math.abs(s)===0,a.position.x=a.position.x+2*i,a.position.y=a.position.y+2*-s;var d=Math.atan2(i,s)-.5*Math.PI,u=d-a.rotation,p=.05;if(Math.abs(u)>p&&(u=u>0?p:-p),a.rotation+=u,c){_.pull(e,a),t.removeChild(a);var h=PIXI.Sprite.fromImage(icon);h.alpha=particleAlpha,h.anchor.set(.5),h.x=Math.random()*o,h.y=Math.random()*r,e.push(h),t.addChild(h)}})}}function updateColors(){var e=[];d3.selectAll("circle.active").each(function(t){var a=d3.rgb(255*t.rgb[0],255*t.rgb[1],255*t.rgb[2]);e.push(a)}),sketch.palette=e}function selectPalette(e){circles.selectAll("circle").remove(),circles.selectAll("circle").data(e).enter().append("circle").attr("cx",function(e){return x(e.x)}).attr("cy",function(e){return y(e.y)}).attr("r",10).style("fill",function(e){return d3.rgb(255*e.rgb[0],255*e.rgb[1],255*e.rgb[2])}).on("click",function(e){console.log("click",e,this),d3.select(this).classed("active",!d3.select(this).classed("active")),updateColors()}),circles.selectAll("circle").classed("active",!0),updateColors()}!function(e,t){"object"==typeof exports?module.exports=t(e,e.document):"function"==typeof define&&define.amd?define(function(){return t(e,e.document)}):e.Sketch=t(e,e.document)}(this,function(e,t){"use strict";function a(e){return"[object Array]"==Object.prototype.toString.call(e)}function n(e){return"function"==typeof e}function i(e){return"number"==typeof e}function o(e){return"string"==typeof e}function r(e){return k[e]||String.fromCharCode(e)}function l(e,t,a){for(var n in t)!a&&n in e||(e[n]=t[n]);return e}function s(e,t){return function(){e.apply(t,arguments)}}function c(e){var t={};for(var a in e)t[a]=n(e[a])?s(e[a],e):e[a];return t}function d(e){function t(t){n(t)&&t.apply(e,[].splice.call(arguments,1))}function a(e){for(F=0;F<ee.length;F++)X=ee[F],o(X)?P[(e?"add":"remove")+"EventListener"].call(P,X,_,!1):n(X)?_=X:P=X}function i(){S(M),M=A(i),q||(t(e.setup),q=n(e.setup)),G||(t(e.resize),G=n(e.resize)),e.running&&!V&&(e.dt=(O=+new Date)-e.now,e.millis+=e.dt,e.now=O,t(e.update),Q&&(e.retina&&(e.save(),e.scale(Y,Y)),e.autoclear&&e.clear()),t(e.draw),Q&&e.retina&&e.restore()),V=++V%e.interval}function s(){P=J?e.style:e.canvas,D=J?"px":"",N=e.width||e.element.width,H=e.height||e.element.height,e.fullscreen&&(H=e.height=x.innerHeight,N=e.width=x.innerWidth),e.retina&&Q&&Y&&(P.style.height=H+"px",P.style.width=N+"px",N*=Y,H*=Y),P.height!==H&&(P.height=H+D),P.width!==N&&(P.width=N+D),q&&t(e.resize)}function d(e,t){return E=t.getBoundingClientRect(),e.x=e.pageX-E.left-(x.scrollX||x.pageXOffset),e.y=e.pageY-E.top-(x.scrollY||x.pageYOffset),e.x*=t.width/E.width,e.y*=t.height/E.height,e}function u(t,a){return d(t,e.element),a=a||{},a.ox=a.x||t.x,a.oy=a.y||t.y,a.x=t.x,a.y=t.y,a.dx=a.x-a.ox,a.dy=a.y-a.oy,a}function p(e){if(e.preventDefault(),U=c(e),U.originalEvent=e,U.touches)for(Z.length=U.touches.length,F=0;F<U.touches.length;F++)Z[F]=u(U.touches[F],Z[F]);else Z.length=0,Z[0]=u(U,K);return l(K,Z[0],!0),U}function h(a){for(a=p(a),z=(B=ee.indexOf(j=a.type))-1,e.dragging=/down|start/.test(j)?!0:/up|end/.test(j)?!1:e.dragging;z;)o(ee[z])?t(e[ee[z--]],a):o(ee[B])?t(e[ee[B++]],a):z=0}function m(a){R=a.keyCode,W="keyup"==a.type,te[R]=te[r(R)]=!W,t(e[a.type],a)}function g(a){e.autopause&&("blur"==a.type?C:f)(),t(e[a.type],a)}function f(){e.now=+new Date,e.running=!0}function C(){e.running=!1}function I(){(e.running?C:f)()}function $(){Q&&e.clearRect(0,0,e.width,e.height)}function L(){T=e.element.parentNode,F=b.indexOf(e),T&&T.removeChild(e.element),~F&&b.splice(F,1),a(!1),C()}var M,_,P,T,E,F,D,O,X,U,j,R,W,z,B,N,H,V=0,Z=[],G=!1,q=!1,Y=x.devicePixelRatio||1,J=e.type==y,Q=e.type==v,K={x:0,y:0,ox:0,oy:0,dx:0,dy:0},ee=[e.element,h,"mousedown","touchstart",h,"mousemove","touchmove",h,"mouseup","touchend",h,"click",h,"mouseout",h,"mouseover",w,m,"keydown","keyup",x,g,"focus","blur",s,"resize"],te={};for(R in k)te[k[R]]=!1;return l(e,{touches:Z,mouse:K,keys:te,dragging:!1,running:!1,millis:0,now:0/0,dt:0/0,destroy:L,toggle:I,clear:$,start:f,stop:C}),b.push(e),e.autostart&&f(),a(!0),s(),i(),e}for(var u,p,h="E LN10 LN2 LOG2E LOG10E PI SQRT1_2 SQRT2 abs acos asin atan ceil cos exp floor log round sin sqrt tan atan2 pow max min".split(" "),m="__hasSketch",g=Math,v="canvas",f="webgl",y="dom",w=t,x=e,b=[],C={fullscreen:!0,autostart:!0,autoclear:!0,autopause:!0,container:w.body,interval:1,globals:!0,retina:!1,type:v},k={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"},I={CANVAS:v,WEB_GL:f,WEBGL:f,DOM:y,instances:b,install:function(e){if(!e[m]){for(var t=0;t<h.length;t++)e[h[t]]=g[h[t]];l(e,{TWO_PI:2*g.PI,HALF_PI:g.PI/2,QUATER_PI:g.PI/4,random:function(e,t){return a(e)?e[~~(g.random()*e.length)]:(i(t)||(t=e||1,e=0),e+g.random()*(t-e))},lerp:function(e,t,a){return e+a*(t-e)},map:function(e,t,a,n,i){return(e-t)/(a-t)*(i-n)+n}}),e[m]=!0}},create:function(e){return e=l(e||{},C),e.globals&&I.install(self),u=e.element=e.element||w.createElement(e.type===y?"div":"canvas"),p=e.context=e.context||function(){switch(e.type){case v:return u.getContext("2d",e);case f:return u.getContext("webgl",e)||u.getContext("experimental-webgl",e);case y:return u.canvas=u}}(),e.exists||(e.container||w.body).appendChild(u),I.augment(p,e)},augment:function(e,t){return t=l(t||{},C),t.element=e.canvas||e,t.element.className+=" sketch",l(e,t,!0),d(e)}},$=["ms","moz","webkit","o"],L=self,M=0,_="AnimationFrame",P="request"+_,T="cancel"+_,A=L[P],S=L[T],E=0;E<$.length&&!A;E++)A=L[$[E]+"Request"+_],S=L[$[E]+"Cancel"+_];return L[P]=A=A||function(e){var t=+new Date,a=g.max(0,16-(t-M)),n=setTimeout(function(){e(t+a)},a);return M=t+a,n},L[T]=S=S||function(e){clearTimeout(e)},I});var layers=[];L.ImageOverlay.Canvas=L.ImageOverlay.extend({includes:L.Mixin.Events,options:{width:1024,height:1024},initialize:function(e,t){"use strict";this._bounds=L.latLngBounds(e),L.Util.setOptions(this,t)},_initImage:function(){"use strict";var e=this._map.latLngToLayerPoint(this._bounds.getNorthWest()),t=this._map.latLngToLayerPoint(this._bounds.getSouthEast()),a=t._subtract(e);this._image=this.canvas=L.DomUtil.create("canvas","leaflet-image-layer"),this.options.id&&(this._image.id=this.options.id),this._image.width=this.options.width||a.x,this._image.height=this.options.width||a.y,this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(this._image,"leaflet-zoom-animated"):L.DomUtil.addClass(this._image,"leaflet-zoom-hide"),this._updateOpacity(),L.Util.extend(this._image,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.Util.bind(this._onImageLoad,this)})},_reset:function(){"use strict";var e=this._image,t=this._map.latLngToLayerPoint(this._bounds.getNorthWest()),a=this._map.latLngToLayerPoint(this._bounds.getSouthEast()),n=a._subtract(t);e.width=this.options.width||n.x,e.height=this.options.width||n.y,L.DomUtil.setPosition(e,t),e.style.width=n.x+"px",e.style.height=n.y+"px"},_onImageLoad:function(){"use strict";this.fire("load")}}),L.imageOverlay.canvas=function(e,t){"use strict";return new L.ImageOverlay.Canvas(e,t)};var ToggleControl=L.Control.extend({options:{position:"topright"},onAdd:function(e){"use strict";var t=L.DomUtil.create("div","my-custom-control leaflet-control leaflet-bar"),a=$('<a id="drawtoggle"></a>');a.append($('<span class="fa-stack"><i class="fa fa-paint-brush fa-stack-1x"></i><i id="drawingban" class="hide fa fa-ban fa-stack-2x"></i></span>')),a.on("click",function(){sketch.painting=!sketch.painting,sketch.painting?($("#drawing").addClass("crosshair"),$("#drawingban").addClass("hide")):($("#drawing").removeClass("crosshair"),$("#drawingban").removeClass("hide"))}),$(t).append(a);var n=$('<a id="maptoggle"></a>');return n.append($('<span class="fa-stack"><i class="fa fa-map-o fa-stack-1x"></i><i id="mapban" class="fa hide fa-ban fa-stack-2x"></i></span>')),n.on("click",function(){$("#mapban").hasClass("hide")?($("#mapban").removeClass("hide"),lockMap(e)):($("#mapban").addClass("hide"),unlockMap(e))}),$(t).append(n),t}});$(function(){"use strict";L.mapbox.accessToken="pk.eyJ1Ijoic2lnZ3lmIiwiYSI6Il8xOGdYdlEifQ.3-JZpqwUa3hydjAJFXIlMA";var e=L.mapbox.map("map","siggyf.c74e2e04");L.control.sidebar("sidebar").addTo(e);var t=new ToggleControl({});t.addTo(e),document.addEventListener("model-selected",function(t){var a=t.detail;console.log("model selected",a),loadModel(e,a);var n=new CustomEvent("model-layers",{detail:a});document.dispatchEvent(n)}),$("#lockmap").is(":checked")?lockMap(e):unlockMap(e),$("#lockmap").on("switchChange.bootstrapSwitch",function(t){console.log(t),$("#lockmap").is(":checked")?lockMap(e):unlockMap(e)})});var fragmentSource=["precision mediump float;","varying vec2 vMapCoord;","varying vec2 vTextureCoord;","varying vec4 vColor;","uniform vec2 scale;","uniform bool flipv;","uniform bool upwind;","uniform sampler2D uSampler;","uniform sampler2D mapSampler;","void main(void)","{","vec4 map =  texture2D(mapSampler, vMapCoord);","float extrascale = 1.0;","map -= 0.5;","map.xy *= scale * extrascale;","if (flipv) {","map.y = - map.y;","}","vec2 lookup = vec2(vTextureCoord.x - map.x, vTextureCoord.y - map.y);","if (upwind) {"," vec4 vUpwind = texture2D(mapSampler, vec2(vMapCoord.x - map.x, vMapCoord.y - map.y ));"," vUpwind -= 0.5;"," if (flipv) {","  vUpwind.y = - vUpwind.y;"," }"," vUpwind.xy *= scale *extrascale;"," /* overwrite lookup with upwind */"," lookup = vec2(vTextureCoord.x - 0.5*(map.x + vUpwind.x), vTextureCoord.y - 0.5* (map.y + vUpwind.y));","}","/* stop rendering if masked */","gl_FragColor = texture2D(uSampler, lookup);","if (map.z > 0.0) {","gl_FragColor *= 0.0;","}","}"].join("\n");console.log(fragmentSource),AdvectionFilter.prototype=Object.create(PIXI.AbstractFilter.prototype),AdvectionFilter.prototype.constructor=AdvectionFilter,AdvectionFilter.prototype.applyFilter=function(e,t,a){var n=e.filterManager;n.calculateMappedMatrix(t.frame,this.maskSprite,this.maskMatrix),this.uniforms.otherMatrix.value=this.maskMatrix.toArray(!0),this.uniforms.scale.value.x=this.scale.x*(1/t.frame.width),this.uniforms.scale.value.y=this.scale.y*(1/t.frame.height),this.uniforms.flipv.value=this.flipv,this.uniforms.upwind.value=this.upwind;var i=this.getShader(e);n.applyFilter(i,t,a)},Object.defineProperties(AdvectionFilter.prototype,{map:{get:function(){return this.uniforms.mapSampler.value},set:function(e){this.uniforms.mapSampler.value=e}}});var sketch;$(function(){var e=$("#brush-size").slider();e.on("change",function(e){sketch.radius=e.value.newValue}),$("#images a.thumbnail").click(function(e){var t=$(e.currentTarget).find("img").attr("src"),a=new Image;a.onload=function(){sketch.drawImage(a,0,0)},a.src=t,e.preventDefault()}),document.addEventListener("model-layers",function(e){var t=e.detail;console.log("model layers created",t),_.startsWith(_.first(t.uv).type,"image")?loadImage(t):loadVideo(t),sketch=addDrawing($("#drawing")[0],$("#drawingcontainer")[0]);var a=new CustomEvent("model-loaded",{detail:t});document.dispatchEvent(a)}),fetch("data/colourlovers.json").then(function(e){return e.json()}).then(function(e){var t=$("#colours-template").html(),a=Handlebars.compile(t),n=a({palettes:e});$("#colours").html(n),_.map(e,function(e){$("#palette"+e.id).click(function(){console.log(e.colors,sketch.palette),sketch.palette=_.map(e.colors,function(e){return"#"+e})})})})["catch"](function(e){console.log("parsing failed",e)})}),$(function(){document.addEventListener("model-loaded",function(e){var t=e.detail;console.log("model loaded",t),startModel(t);var a=new CustomEvent("model-started",{detail:t});document.dispatchEvent(a)})}),$(function(){fetch("data/models.json").then(function(e){return e.json()}).then(function(e){var t=$("#model-template").html(),a=Handlebars.compile(t),n=a(e);$("#models").html(n),_.map(e.models,function(e){$("#"+e.id).find("a.load-model").click(function(){console.log(e);var t=new CustomEvent("model-selected",{detail:e});document.dispatchEvent(t)})}),document.dispatchEvent(new CustomEvent("model-selected",{detail:e.models[0]}))})["catch"](function(e){console.log("parsing failed",e)})});var displacementFilter,icon="images/verticalbar.png",particleAlpha=.6;$(function(){"use strict";document.addEventListener("model-started",function(e){function t(){requestAnimationFrame(t),v.scale.y=-1,p.update(),l.render(s),w.render(s,null,!0),$("#cleardrawing").is(":checked")&&u.clearRect(0,0,d.width,d.height),y.texture=w;var e=f;f=w,w=e,w.clear(),particleTimestep(C,b),C.length>500&&f.clear()}function a(){w.clear(),f.clear()}var n=e.detail;console.log("model started",n),console.log("looking for webgl context",$("#webgl"));var i=$("#webgl")[0],o=i.width,r=i.height,l=new PIXI.WebGLRenderer(o,r,{view:i,transparent:!0});console.log("created renderer",l);var s=new PIXI.Container,c=new PIXI.Container;s.addChild(c);var d=$("#drawing")[0],u=d.getContext("2d"),p=PIXI.Texture.fromCanvas(d),h=new PIXI.Sprite(p),m=$("#uv")[0];console.log("video",m);var g=PIXI.Texture.fromVideo(m),v=new PIXI.Sprite(g);v.width=o,v.height=r,displacementFilter=new AdvectionFilter(v,{scale:n.scale,flipv:n.flipv,upwind:!1}),s.addChild(v),c.filters=[displacementFilter],displacementFilter.scale.x=2,displacementFilter.scale.y=2;var f=new PIXI.RenderTexture(l,o,r),y=new PIXI.Sprite(f),w=new PIXI.RenderTexture(l,o,r);c.addChild(y),c.addChild(h);var x=0,b=new PIXI.ParticleContainer(x,{scale:!0,position:!0,rotation:!0,uvs:!0,alpha:!0});c.addChild(b);var C=[];particleCulling(C,b,x),t(),$("#clear3d").click(a);var k=$("#n-particles").slider();k.on("change",function(e){var t=e.value.newValue;particleCulling(C,b,t)}),$(document).keydown(function(e){console.log("processing key",e.which),80===e.which&&(console.log("setting particles to",C.length+50),particleCulling(C,b,C.length+50)),67===e.which&&a()})})});var width=300,height=200,svg=d3.select("#paintings").append("svg"),circles=svg.append("g");svg.attr("width",width).attr("height",height);var x=d3.scale.linear().range([0,width]).domain([-.1,1.1]).nice(),y=d3.scale.linear().range([height,0]).domain([-.1,1.1]).nice();d3.select("#paintingsclear").on("click",function(){d3.selectAll("circle.active").classed("active",!1),updateColors()}),d3.select("#paintingsall").on("click",function(){d3.selectAll("circle").classed("active",!0),updateColors()}),d3.json("data/palettes.json",function(e,t){d3.select("#paintings").append("div").classed("row",!0).selectAll("div").data(t).enter().append("div").classed({"col-xs-3":!0,thumbnail:!0}).append("img").attr("width","60").attr("height","40").attr("src",function(e){return e.url}).on("click",function(e){console.log("click",e,this),selectPalette(e.palette)});var a=t[0].palette;selectPalette(a)}),$(function(){$('input[type="checkbox"]').bootstrapSwitch()});